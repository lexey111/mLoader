/***
 mLoader | JS Mini Loader
 (c) lexey111, 2015
 */
var mLoader
mLoader&&mLoader.load&&"function"==typeof mLoader.load?console.warn("JS mLoader module has been already attached. Please do not include it twice."):mLoader=function(){"use strict"
function e(t,r){for(var n in r)try{r[n].constructor==Object?t[n]=e(t[n],r[n]):t[n]=r[n]}catch(i){t[n]=r[n]}return t}function t(){var e={}
return e.promise=new Promise(function(t,r){e.resolve=t,e.reject=r}),e}function r(e){return"object"==typeof e&&e.sort&&"function"==typeof e.sort}function n(e){return"string"==typeof e}function i(e){return"object"==typeof e&&!r(e)}function o(e){return new Promise(function(t){return e?void setTimeout(function(){t()},e):t()})}function s(e){if(!e)return[]
var t=[],r=e.replace(/\s/g,"").replace(/,,/g,",").replace(/;;/g,";").split(";")
return r.every(function(e){if(!e)return!0
if(-1===e.indexOf(","))t.push(e)
else{var r=e.split(","),n=[]
r.every(function(e){return e&&n.push(e),!0}),n.length&&t.push(n)}return!0}),t}function a(e){var r,n=new t,i=new XMLHttpRequest
return Object.keys(e.headers||{}).forEach(function(t){i.setRequestHeader(t,e.headers[t])}),e.data&&"object"==typeof e.data&&(i.setRequestHeader("Content-type","application/json"),r=JSON.stringify(e.data)),i.onreadystatechange=function(t){4===i.readyState&&(-1===[200,304].indexOf(i.status)?n.reject(new Error("Server responded with a status of ["+i.status+"] during loading "+(i.responseURL||e.url))):n.resolve(i.response?i.response:i.responseText))},i.open(e.method||"GET",e.url,!0),i.send(r),n.promise}function l(e,t){var r
if("script"==t.type)return r=document.createElement("script"),r.language="javascript",r.type="text/javascript",r.defer=!0,r.text=e,r.setAttribute("data-origin",t.url),void g.appendChild(r)
if("css"==t.type)return r=document.createElement("style"),r.setAttribute("rel","stylesheet"),r.setAttribute("type","text/css"),r.innerHTML=e,r.setAttribute("data-origin",t.url),void g.appendChild(r)
throw new Error("Invalid content type!")}function u(e){var t
if(t=n(e)?e:i(e)?e.config_url:void 0,!t)throw new Error("Please set [config_url] parameter")
return a({method:"POST",url:t,data:e.config_params||void 0}).then(function(e){if(!e)return Promise.reject("No config data available!")
var t
try{return t=JSON.parse(e),i(t)?t&&t.files?t.files:Promise.reject("Invalid response: no [files] field returned!"):t}catch(r){return Promise.reject("Bad config format: "+r.message)}})}function f(e){return Promise.resolve(e)}function c(e){if("undefined"!=typeof Promise)return void e.start()
e.log.write("Loading Promise polyfill "+e.config.promise_polyfill+"...")
var t=document.createElement("script")
t.language="javascript",t.type="text/javascript",t.defer=!0,t.onerror=function(){throw new Error("Cannot load Promise support library!")},t.onload=function(){if(e.log.write("Promise support library loaded."),"undefined"==typeof Promise)throw new Error("No Promise support available! Please set up valid [polyfill] library.")
e.start()},t.src=m.getScriptURL(e.config.promise_polyfill,e.config.folder_prefix).url,g.appendChild(t)}function d(e,t){if("object"==typeof e)for(var r=0;r<e.length;r++)d(e[r],t)
else t(e)}function p(e,t){var r=new y(e,t)
c(r)}var g=document.getElementsByTagName("HEAD").item(0),h=function(e){this.verbose=e}
h.prototype={warning:function(){console.warn.apply(console,arguments)},write:function(){this.verbose&&console.log.apply(console,arguments)},error:function(){console.error.apply(console,arguments)}}
var m={getFileExt:function(e){if(!e||"string"!=typeof e||e.length<2)return""
var t=/(?:\.([^.]+))?$/.exec(e)[1]||"",r=t.indexOf("?")
return-1!==r&&(t=t.substr(0,r)),t},getGetParams:function(e){return!e||"string"!=typeof e||e.length<2?"":/(?:\?([^.]+))?$/.exec(e)[1]||""},getFileName:function(e){var t=e.replace(/^.*(\\|\/|\:)/,"")
t&&t.length&&"."==t[0]&&(t="")
var r=t.indexOf("?")
return-1!==r&&(t=t.substr(0,r)),t},getFileNameWOExt:function(e){var t=this.getFileName(e),r=this.getFileExt(t)
return r?t.substr(0,t.length-r.length-1):t},getFilePath:function(e){if(!e||"string"!=typeof e||!e.length)return""
var t=/^.*(\\|\/|\:)/.exec(e)
return t&&t.length?t[0]||"":""},_decodeFileTypeByExt:function(e){var t=e.toLowerCase()
return"js"==t?"script":"css"==t?"css":void 0},getScriptURL:function(e,t){var r={origin:e,filename:"",name:"",ext:"",type:"",path:"",get_params:"",url:""}
if(r.get_params=this.getGetParams(e),r.ext=this.getFileExt(e),r.ext||(r.ext="js",e+="."+r.ext),r.filename=this.getFileName(e),r.name=this.getFileNameWOExt(e),r.path=this.getFilePath(e),r.type=this._decodeFileTypeByExt(r.ext),!r.type)throw new Error("Can't resolve file type for "+e)
return r.path||(r.path=t),r.url=r.path+r.filename,r.get_params&&(r.url+="?"+r.get_params),r}},y=function(t,r){this.config=e({verbose:!1,start_delay:0,folder_prefix:"js/",promise_polyfill:"https://www.promisejs.org/polyfills/promise-6.1.0.min.js",onStart:void 0,onProgress:void 0,onFinish:void 0,onFail:void 0},this._parseConfig(t,r)),this.state={status:"ready",file_list:void 0,queue:[],modules:[]},this._fatal_error=!1,this._error_message="",this.log=new h(this.config.verbose)}
return y.prototype={_parseConfig:function(e,t){var r={}
return r.file_list=e||{},t&&i(t)?("undefined"!=typeof t.verbose&&(r.verbose=!!t.verbose),t.delay&&(r.start_delay=parseInt(t.delay)||0),t.folder&&(r.folder_prefix=t.folder||"js/",-1===r.folder_prefix.indexOf("/")&&-1===r.folder_prefix.indexOf("\\")&&(r.folder_prefix+="/")),t.polyfill&&(r.promise_polyfill=t.polyfill),t.start&&"function"==typeof t.start&&(r.onStart=t.start),t.progress&&"function"==typeof t.progress&&(r.onProgress=t.progress),t.finish&&"function"==typeof t.finish&&(r.onFinish=t.finish),t.fail&&"function"==typeof t.fail&&(r.onFail=t.fail),r):r},setState:function(e){this.state.status=e,this.log.write("[mL] Set mLoader state [%s]",e)},_setFatalError:function(e){this.setState("error")
var t=""
e&&(t=n(e)?e:e.message?e.message:"unknown error",this.log.error(e)),t&&(this._error_message=t),this._fatal_error=!0},_loadQueuedFile:function(e,t){if(!this._fatal_error){if(!n(e))throw new Error("Bad file name type (not a string): "+e.toString())
var r=m.getScriptURL(e,this.config.folder_prefix)
if(!r.url)throw new Error("Bad file URL for "+e.toString())
if(this.state.queue[r.url])return void this.log.warning("[mL] File is already requested: "+r.url)
this.state.queue[r.url]=r,this.state.queue[r.url].state="pending",this.log.write("[mL] Queued",e,r.url)
var i=this
return a({url:r.url}).then(function(e){return i._fatal_error?void 0:(l(e,r),i.log.write("[mL] File attached",r.url),i.config.onProgress&&i.config.onProgress(r.url,e.length),e)}).then(function(n){return i.state.modules.push({origin:e,url:r.url,length:n?n.length:0,loaded_at:new Date,mode:t}),n},function(e){return i._setFatalError(e.message),Promise.reject(e)})}},_isRemoteAPIAddr:function(e){return n(e)&&-1===e.indexOf(";")&&-1===e.indexOf(",")||i(e)},_loadFileList:function(){var e,t=this.config.file_list
if(this._isRemoteAPIAddr(t)?e=u(t):(n(t)&&(t=s(t)),t.length&&(e=f(t))),!e)throw new Error("Loader can't resolve config provider.")
var r=this
return e.then(function(e){if(r.setState("processing"),n(e)&&(e=s(e)),r.log.write("Config ready:",e),r.config.onStart){var t=0
d(e,function(){t++}),r.config.onStart(e,t)}return e},function(e){return r.log.error(e),r._setFatalError("Fatal error during processing the config"),Promise.reject(e)})},_constructQueue:function(e){var i=this
return new Promise(function(o,s){var a=new t,l=a.promise
l.then(function(e){e.every(function(e){return n(e)?l=l.then(function(){return i._loadQueuedFile(e,"sequenced")}):r(e)&&(l=l.then(function(){return Promise.all(e.map(function(e){return i._loadQueuedFile(e,"parallel")}))})),!0}),l=l.then(function(){i._done()})["catch"](function(e){return s(e)})}),a.resolve(e)})},_done:function(){this.setState("done"),this.config.onFinish&&this.config.onFinish(this.state.modules)},start:function(){if("ready"!==this.state.status)return void this.log.warning("[mL] Loader is already in state ["+this.state.status+"]")
this.log.write('[mL] Verbose "%s"',this.config.verbose),this.log.write("[mL] Starting delay",this.config.start_delay),this.log.write('[mL] Folder prefix "%s"',this.config.folder_prefix),this.log.write('[mL] Promise polyfill URL "%s"',this.config.promise_polyfill),this.setState("prepare")
var e=this
o(this.config.start_delay).then(function(){return e._loadFileList().then(function(t){return e._constructQueue(t)})})["catch"](function(t){var r=t.message?t.message:t
e._setFatalError(r),e.config.onFail&&e.config.onFail(r)})}},{load:p}}()
